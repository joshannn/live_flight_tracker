<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Plane Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            overflow: hidden;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: 350px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(148, 163, 184, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
        }

        #header {
            padding: 25px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #location-info {
            padding: 20px;
            background: rgba(30, 41, 59, 0.5);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .info-label {
            color: #94a3b8;
        }

        .info-value {
            font-weight: 600;
            color: #f8fafc;
        }

        #plane-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .plane-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .plane-card:hover {
            transform: translateX(5px);
            background: rgba(51, 65, 85, 0.8);
            border-color: #3b82f6;
        }

        .plane-card.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .plane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .plane-callsign {
            font-weight: 700;
            font-size: 16px;
            color: #60a5fa;
        }

        .plane-altitude {
            font-size: 12px;
            background: rgba(59, 130, 246, 0.2);
            padding: 3px 8px;
            border-radius: 12px;
            color: #93c5fd;
        }

        .plane-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
            color: #94a3b8;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .detail-icon {
            width: 16px;
            text-align: center;
        }

        #map {
            flex: 1;
            background: #0f172a;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .plane-icon {
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
            transition: transform 0.3s ease;
        }

        .plane-icon:hover {
            transform: scale(1.2);
        }

        .radar-sweep {
            position: absolute;
            width: 100%;
            height: 100%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(59, 130, 246, 0.1) 60deg, transparent 120deg);
            animation: radar 4s linear infinite;
            pointer-events: none;
        }

        @keyframes radar {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
        }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 20px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .no-planes {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .no-planes-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .trail-line {
            stroke: #3b82f6;
            stroke-width: 2;
            stroke-opacity: 0.6;
            fill: none;
            stroke-dasharray: 5, 5;
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to { stroke-dashoffset: -100; }
        }

        .distance-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(15, 23, 42, 0.9);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="sidebar">
            <div id="header">
                <h1>‚úàÔ∏è SkyTracker</h1>
                <div class="status">
                    <span class="status-dot"></span>
                    <span id="status-text">Initializing...</span>
                </div>
            </div>
            
            <div id="location-info">
                <div class="info-row">
                    <span class="info-label">Your Location:</span>
                    <span class="info-value" id="loc-coords">Detecting...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Planes in Range:</span>
                    <span class="info-value" id="plane-count">0</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Update:</span>
                    <span class="info-value" id="last-update">--:--:--</span>
                </div>
            </div>

            <div id="plane-list">
                <div class="loading" id="initial-loading">
                    <div class="spinner"></div>
                    <div>Detecting your location...</div>
                </div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script>
        // State management
        let map;
        let userMarker;
        let planes = new Map();
        let planeMarkers = new Map();
        let planeTrails = new Map();
        let watchId;
        let updateInterval;
        let userLocation = null;

        // Initialize map
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([20, 0], 2);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                subdomains: 'abcd'
            }).addTo(map);

            L.control.zoom({ position: 'bottomright' }).addTo(map);
        }

        // Custom plane icon
        function createPlaneIcon(heading, color = '#3b82f6') {
            const svg = `
                <svg width="30" height="30" viewBox="0 0 24 24" fill="${color}" style="transform: rotate(${heading}deg);">
                    <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                </svg>
            `;
            return L.divIcon({
                html: svg,
                className: 'plane-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Format coordinates
        function formatCoords(lat, lon) {
            return `${lat.toFixed(4)}¬∞, ${lon.toFixed(4)}¬∞`;
        }

        // Update location display
        function updateLocationDisplay(lat, lon) {
            document.getElementById('loc-coords').textContent = formatCoords(lat, lon);
        }

        // Fetch planes from OpenSky Network
        async function fetchPlanes(lat, lon) {
            // Search within ~50km radius (roughly 0.5 degrees)
            const latMin = lat - 0.5;
            const latMax = lat + 0.5;
            const lonMin = lon - 0.5;
            const lonMax = lon + 0.5;

            try {
                const response = await fetch(
                    `https://opensky-network.org/api/states/all?lamin=${latMin}&lamax=${latMax}&lomin=${lonMin}&lomax=${lonMax}`
                );
                
                if (!response.ok) throw new Error('Failed to fetch');
                
                const data = await response.json();
                return data.states || [];
            } catch (error) {
                console.error('Error fetching planes:', error);
                return [];
            }
        }

        // Update plane list in sidebar
        function updatePlaneList(planesData) {
            const listContainer = document.getElementById('plane-list');
            const planeCount = document.getElementById('plane-count');
            
            // Clear loading
            if (document.getElementById('initial-loading')) {
                listContainer.innerHTML = '';
            }

            if (planesData.length === 0) {
                listContainer.innerHTML = `
                    <div class="no-planes">
                        <div class="no-planes-icon">‚úàÔ∏è</div>
                        <div>No planes in range</div>
                        <div style="font-size: 12px; margin-top: 5px;">Try again in a few moments</div>
                    </div>
                `;
                planeCount.textContent = '0';
                return;
            }

            planeCount.textContent = planesData.length;

            // Sort by distance
            const sortedPlanes = planesData.map(plane => {
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lon,
                    plane[6], plane[5]
                );
                return { ...plane, distance };
            }).sort((a, b) => a.distance - b.distance);

            listContainer.innerHTML = '';
            
            sortedPlanes.forEach((plane, index) => {
                const icao = plane[0];
                const callsign = (plane[1] || 'Unknown').trim();
                const origin = plane[2] || 'Unknown';
                const altitude = plane[7] ? Math.round(plane[7] * 3.28084) : 'N/A'; // Convert to feet
                const velocity = plane[9] ? Math.round(plane[9] * 2.23694) : 'N/A'; // Convert to mph
                const heading = plane[10] || 0;
                
                const card = document.createElement('div');
                card.className = 'plane-card';
                card.dataset.icao = icao;
                card.innerHTML = `
                    <div class="distance-badge">${plane.distance.toFixed(1)} km</div>
                    <div class="plane-header">
                        <span class="plane-callsign">${callsign}</span>
                        <span class="plane-altitude">${altitude !== 'N/A' ? altitude + ' ft' : 'N/A'}</span>
                    </div>
                    <div class="plane-details">
                        <div class="detail-item">
                            <span class="detail-icon">üõ´</span>
                            <span>${origin}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-icon">üí®</span>
                            <span>${velocity !== 'N/A' ? velocity + ' mph' : 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-icon">üß≠</span>
                            <span>${Math.round(heading)}¬∞</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-icon">üì°</span>
                            <span>${icao}</span>
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => focusOnPlane(plane));
                card.addEventListener('mouseenter', () => highlightPlane(icao));
                card.addEventListener('mouseleave', () => unhighlightPlane(icao));
                
                listContainer.appendChild(card);
            });
        }

        // Update map markers
        function updateMapMarkers(planesData) {
            const currentIcaos = new Set(planesData.map(p => p[0]));
            
            // Remove planes that are no longer in range
            planeMarkers.forEach((marker, icao) => {
                if (!currentIcaos.has(icao)) {
                    map.removeLayer(marker);
                    planeMarkers.delete(icao);
                    if (planeTrails.has(icao)) {
                        map.removeLayer(planeTrails.get(icao));
                        planeTrails.delete(icao);
                    }
                }
            });

            // Update or add planes
            planesData.forEach(plane => {
                const icao = plane[0];
                const lat = plane[6];
                const lon = plane[5];
                const heading = plane[10] || 0;
                const velocity = plane[9] || 0;

                if (planeMarkers.has(icao)) {
                    // Update existing marker
                    const marker = planeMarkers.get(icao);
                    const oldLatLng = marker.getLatLng();
                    marker.setLatLng([lat, lon]);
                    marker.setIcon(createPlaneIcon(heading));
                    
                    // Update trail
                    if (planeTrails.has(icao)) {
                        const trail = planeTrails.get(icao);
                        const currentLatLngs = trail.getLatLngs();
                        currentLatLngs.push([lat, lon]);
                        if (currentLatLngs.length > 20) currentLatLngs.shift();
                        trail.setLatLngs(currentLatLngs);
                    }
                } else {
                    // Create new marker
                    const marker = L.marker([lat, lon], {
                        icon: createPlaneIcon(heading)
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <b>${plane[1] || 'Unknown'}</b><br>
                        ICAO: ${icao}<br>
                        Altitude: ${plane[7] ? Math.round(plane[7] * 3.28084) + ' ft' : 'N/A'}<br>
                        Speed: ${velocity ? Math.round(velocity * 2.23694) + ' mph' : 'N/A'}
                    `);
                    
                    planeMarkers.set(icao, marker);
                    
                    // Create trail
                    const trail = L.polyline([[lat, lon]], {
                        className: 'trail-line',
                        weight: 2,
                        opacity: 0.6
                    }).addTo(map);
                    planeTrails.set(icao, trail);
                }
            });
        }

        // Focus on specific plane
        function focusOnPlane(plane) {
            const lat = plane[6];
            const lon = plane[5];
            map.setView([lat, lon], 12);
            
            // Highlight in sidebar
            document.querySelectorAll('.plane-card').forEach(card => {
                card.classList.remove('active');
            });
            const card = document.querySelector(`[data-icao="${plane[0]}"]`);
            if (card) {
                card.classList.add('active');
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Open popup
            const marker = planeMarkers.get(plane[0]);
            if (marker) marker.openPopup();
        }

        // Highlight plane on hover
        function highlightPlane(icao) {
            const marker = planeMarkers.get(icao);
            if (marker) {
                marker.setZIndexOffset(1000);
                marker.getElement().style.transform += ' scale(1.3)';
            }
        }

        function unhighlightPlane(icao) {
            const marker = planeMarkers.get(icao);
            if (marker) {
                marker.setZIndexOffset(0);
            }
        }

        // Main update function
        async function updatePlanes() {
            if (!userLocation) return;
            
            document.getElementById('status-text').textContent = 'Updating...';
            
            const planesData = await fetchPlanes(userLocation.lat, userLocation.lon);
            updatePlaneList(planesData);
            updateMapMarkers(planesData);
            
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
            document.getElementById('status-text').textContent = 'Live Tracking';
        }

        // Initialize location
        function initLocation() {
            if (!navigator.geolocation) {
                document.getElementById('plane-list').innerHTML = `
                    <div class="error-message">
                        Geolocation is not supported by your browser
                    </div>
                `;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    
                    updateLocationDisplay(userLocation.lat, userLocation.lon);
                    
                    // Center map on user
                    map.setView([userLocation.lat, userLocation.lon], 10);
                    
                    // Add user marker with radar effect
                    const userIcon = L.divIcon({
                        className: 'user-location',
                        html: '<div style="width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 20px #3b82f6;"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    userMarker = L.marker([userLocation.lat, userLocation.lon], {
                        icon: userIcon,
                        zIndexOffset: 1000
                    }).addTo(map);
                    
                    // Add radar circle
                    L.circle([userLocation.lat, userLocation.lon], {
                        radius: 50000, // 50km
                        fill: false,
                        color: '#3b82f6',
                        weight: 1,
                        opacity: 0.3,
                        dashArray: '5, 10'
                    }).addTo(map);
                    
                    // Initial fetch
                    updatePlanes();
                    
                    // Set up interval for updates
                    updateInterval = setInterval(updatePlanes, 10000); // Update every 10 seconds
                    
                    // Watch position changes
                    watchId = navigator.geolocation.watchPosition((pos) => {
                        userLocation = {
                            lat: pos.coords.latitude,
                            lon: pos.coords.longitude
                        };
                        updateLocationDisplay(userLocation.lat, userLocation.lon);
                        if (userMarker) {
                            userMarker.setLatLng([userLocation.lat, userLocation.lon]);
                        }
                    });
                },
                (error) => {
                    let message = 'Unable to retrieve your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = "Location access denied. Please enable location services.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = "Location information unavailable.";
                            break;
                        case error.TIMEOUT:
                            message = "Location request timed out.";
                            break;
                    }
                    document.getElementById('plane-list').innerHTML = `
                        <div class="error-message">${message}</div>
                        <button class="refresh-btn" onclick="location.reload()">Try Again</button>
                    `;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initLocation();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (updateInterval) clearInterval(updateInterval);
        });
    </script>
</body>
</html>